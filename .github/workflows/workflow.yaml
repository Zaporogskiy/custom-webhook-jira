# .github/workflows/jira-webhook.yml
name: Jira webhook (draft release + manual)

on:
  # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–ª–∏–∑–∞ (–≤ —Ç.—á. draft)
  release:
    types: [created]
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º JSON
  workflow_dispatch:
    inputs:
      custom_payload:
        description: 'Custom JSON payload for Jira (optional)'
        required: false
        default: '{}'

jobs:
  notify-jira:
    runs-on: ubuntu-latest
    env:
      JIRA_WEBHOOK_URL: ${{ secrets.JIRA_WEBHOOK_URL }}
      JIRA_WEBHOOK_TOKEN: ${{ secrets.JIRA_WEBHOOK_TOKEN }}

    # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–∂–æ–±:
    # - –≤—Å–µ–≥–¥–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
    # - –∏–ª–∏ –µ—Å–ª–∏ —Å–æ–∑–¥–∞–Ω release –∏ –æ–Ω –∏–º–µ–Ω–Ω–æ draft
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'release' &&
       github.event.action == 'created' &&
       github.event.release.draft == true)

    steps:
      - name: Build payload file
        id: payload
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üîß Manual trigger"
            printf '%s' '${{ inputs.custom_payload }}' > payload.json
          else
            echo "üìù Draft release created: ${{ github.event.release.tag_name }}"
            # –ö–ª–∞–¥—ë–º –í–ï–°–¨ event –≤ —Ñ–∞–π–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ
            cat > payload.json <<'JSON'
            ${{ toJson(github.event) }}
            JSON
          fi
          echo "payload_path=payload.json" >> "$GITHUB_OUTPUT"
          echo "Payload bytes:"; wc -c payload.json

      - name: POST to Jira Automation webhook
        run: |
          set -euo pipefail
          HTTP_CODE=$(curl -sS -o /tmp/resp.txt -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Automation-Webhook-Token: ${JIRA_WEBHOOK_TOKEN}" \
            --data-binary @"${{ steps.payload.outputs.payload_path }}" \
            "${JIRA_WEBHOOK_URL}")

          echo "HTTP: $HTTP_CODE"
          cat /tmp/resp.txt || true

          # –§–µ–π–ª–∏–º –¥–∂–æ–±, –µ—Å–ª–∏ –Ω–µ 2xx ‚Äî —É–¥–æ–±–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
          test "${HTTP_CODE:0:1}" = "2"
          echo "‚úÖ Sent to Jira"